#!/bin/sh

srcfile=$1
shift
execfile=$(mktemp)
outfile=$(mktemp)
trap 'rm "$outfile" "$execfile"' EXIT
trap exit INT TERM HUP

printf %s "
	export PS4
	PS4='+ \$(date +%s%N) '
	exec 9<> $outfile
	BASH_XTRACEFD=9
	set -x
" > "$execfile"

cat "$srcfile" >> "$execfile"

unshare -cm --keep-caps sh -c '
	mount -o bind -- "$1" "$2"
	file=$2
	shift 2
	unshare -c bash -- "$file" "$@"
' sh "$execfile" "$srcfile" "$@"

<"$outfile" awk '{
		currentOne=$1; currentNum=$2; $1=""; $2=""
		sub(/^\s+/, "")
		if (NR > 1) {
			t = ((currentNum - prevNum) / 1000000)
			sum += t
			printf("%6.0f: %s\n", t, prevLine);
		}
		prevLine = substr(currentOne, 2) " " $0; prevNum = currentNum
	} END{printf("%6.0f sum\n", sum)}' >&2
