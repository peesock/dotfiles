#!/bin/sh
set -ux

[ $# -lt 2 ] && exit 1
[ "$1" = 'a' ] && type=alsa
[ "$1" = 'p' ] && type=pipe

[ "$2" = 'vol' ] && dir=$3 && value=$4 && action=volume && shift 2
[ "$2" = 'mute' ] && action=mute
shift 2

quiet=
[ $# -gt 0 ] &&
while true; do
	[ "$1" = '-q' ] && quiet=true && shift && continue
	break
done

[ "$type" = alsa ] && {
	deviceId=${2-default}
	[ "$action" = volume ] && {
		amixer -qMD "$deviceId" sset "$1" "$value%$dir"
		[ "$quiet" ] ||
				notify-send -r 13 -u low -t 1000 "$1:" "$(amixer -D "$deviceId" sget "$1" | grep -F '%]' | awk -F'[][]' 'NR==1{ print $2 }')" &
	}

	[ "$action" = mute ] && {
		amixer -qD "$deviceId" sset "$1" toggle
		[ "$quiet" ] ||
			notify-send -r 13 -u low -t 1000 "$1:" "$(amixer -D "$deviceId" sget "$1" | grep -qF '[on]' && printf "on" || printf "off")" &
	}
}

[ "$type" = pipe ] && {
	if [ "$1" ]; then
		deviceId=$(pw-dump Node | jq '.[] | select(.info.props."node.name" == "'"$1"'") | .id')
		deviceName=$1
	else
		deviceName=$(pw-dump | jq '.[] |
			select(.type == "PipeWire:Interface:Metadata") |
			select (.props."metadata.name" == "default").metadata.[] |
			select (.key == "default.audio.sink").value.name' -r)
		deviceId="@DEFAULT_AUDIO_SINK@"
	fi
	[ "$action" = volume ] && {
		wpctl set-volume -l 1.60 "$deviceId" "$value%$dir"
		vol=$(wpctl get-volume "$deviceId" | awk '{if ($3) s="% " $3; else s="%"; print ($2 * 100) s}')
		[ "$quiet" ] ||
			notify-send -r 13 -u low -t 1000 "$deviceName:" "$vol" &
	}

	[ "$action" = mute ] && {
			wpctl set-mute "$deviceId" toggle
		[ "$quiet" ] ||
			mute=$(wpctl get-volume "$deviceId" | grep -iFq 'muted' && echo off || echo on)
			notify-send -r 13 -u low -t 1000 "$deviceName:" "$mute" &
	}
}
true
